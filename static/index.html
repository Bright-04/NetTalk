<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>LAN Terminal Chat</title>
		<style>
			html,
			body {
				height: 100%;
				margin: 0;
			}
			body {
				background: #000;
				color: #b6f36b;
				font-family: Menlo, Consolas, monospace;
			}
			.wrap {
				display: flex;
				flex-direction: column;
				height: 100vh;
				padding: 10px;
				box-sizing: border-box;
			}
			#terminal {
				flex: 1;
				overflow: auto;
				white-space: pre-wrap;
				word-break: break-word; /* allow long words/URLs to wrap */
			}
			.input-row {
				display: flex;
				gap: 8px;
				margin-top: 8px;
			}
			#prompt {
				min-width: 90px;
				color: #6ef;
			}
			#cmd {
				flex: 1;
				background: #000;
				border: 1px solid #333;
				color: inherit;
				padding: 6px;
				font-family: inherit;
				font-size: 14px;
			}
			.meta {
				color: #888;
				font-size: 12px;
			}
			.meta.rate {
				color: #f66; /* red-ish */
				font-weight: 600;
			}
			.line .from {
				color: #6ef;
				white-space: nowrap;
			}
			.line .ip {
				color: #8fb;
				margin-left: 6px;
				font-size: 12px;
			}
			.line .time {
				color: #777;
				margin-left: 6px;
				font-size: 12px;
			}
		</style>
	</head>
	<body>
		<div class="wrap">
			<div id="terminal"></div>
			<div class="input-row">
				<div id="prompt">you@lan</div>
				<input id="cmd" autocomplete="off" autofocus placeholder="Type message and press Enter" />
			</div>
		</div>

		<script>
			const terminal = document.getElementById("terminal");
			const cmd = document.getElementById("cmd");
			let username = "";

			// DOM-safe helpers
			function appendLineNode(children, className = "line") {
				const div = document.createElement("div");
				div.className = className;
				children.forEach((node) => div.appendChild(node));
				terminal.appendChild(div);
				terminal.scrollTop = terminal.scrollHeight;
			}

			function textNode(text) {
				return document.createTextNode(text);
			}

			function metaNode(text) {
				const span = document.createElement("span");
				span.className = "meta";
				span.appendChild(textNode(text));
				return span;
			}

			function nameNode(name) {
				const s = document.createElement("span");
				s.className = "from";
				s.appendChild(textNode(name));
				return s;
			}

			function ipNode(ip) {
				const s = document.createElement("span");
				s.className = "ip";
				s.appendChild(textNode(ip));
				return s;
			}

			function appendMetaText(text) {
				appendLineNode([metaNode(text)]);
			}

			function rateNode(text) {
				const span = document.createElement("span");
				span.className = "meta rate";
				span.appendChild(textNode(text));
				return span;
			}

			function appendRateNotice(text) {
				appendLineNode([rateNode(text)]);
			}

			function timeNow() {
				const d = new Date();
				return d.toLocaleTimeString();
			}

			async function start() {
				username = prompt("Enter display name", "") || "You";
				document.getElementById("prompt").textContent = username + "@lan";

				const proto = location.protocol === "https:" ? "wss" : "ws";
				const wsUrl = proto + "://" + location.host + "/ws";
				const ws = new WebSocket(wsUrl);

				ws.addEventListener("open", () => {
					appendMetaText("[connected to server]");
					ws.send(JSON.stringify({ type: "join", username }));
				});

				ws.addEventListener("message", (ev) => {
					try {
						const m = JSON.parse(ev.data);
						if (m.type === "welcome") {
							// server assigned/cleaned username
							username = m.username || username;
							document.getElementById("prompt").textContent = username + "@lan";
							return;
						}
						if (m.type === "rate_limited") {
							const retry = m.retry_after || 1;
							appendRateNotice(`[rate-limited] slow down â€” retry in ${retry}s`);
							return;
						}

						if (m.type === "too_many_logins") {
							appendRateNotice(`[connection refused] too many connections from your IP (limit ${m.limit})`);
							return;
						}

						if (m.type === "join") {
							const time = "[" + timeNow() + "] ";
							const nodes = [metaNode(time), nameNode(m.from)];
							if (m.ip) nodes.push(ipNode(m.ip));
							nodes.push(textNode(" joined the chat"));
							appendLineNode(nodes);
						} else if (m.type === "leave") {
							const time = "[" + timeNow() + "] ";
							const nodes = [metaNode(time), nameNode(m.from)];
							if (m.ip) nodes.push(ipNode(m.ip));
							nodes.push(textNode(" left"));
							appendLineNode(nodes);
						} else if (m.type === "message") {
							const nodes = [nameNode(m.from)];
							if (m.ip) nodes.push(ipNode(m.ip));
							nodes.push(textNode(": " + (m.text || "")));
							nodes.push(textNode(" "));
							const t = document.createElement("span");
							t.className = "time";
							t.appendChild(textNode(timeNow()));
							nodes.push(t);
							appendLineNode(nodes);
						}
					} catch (e) {
						console.error(e);
					}
				});

				ws.addEventListener("close", () => appendMetaText("[disconnected]"));
				ws.addEventListener("error", () => appendMetaText("[connection error]"));

				cmd.addEventListener("keydown", (e) => {
					if (e.key === "Enter") {
						const text = cmd.value.trim();
						if (!text) return;
						ws.send(JSON.stringify({ type: "message", text }));
						cmd.value = "";
					}
				});
			}

			start();
		</script>
	</body>
</html>
